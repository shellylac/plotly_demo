---
title: "Plotly Tutorial for R: Interactive Visualizations"
author: "Tutorial"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Setup

```{r load-packages}
# Install if needed: install.packages("plotly")
library(plotly)
library(dplyr)
library(readr)
library(here)
```

------------------------------------------------------------------------

# Plotly (R) Grammar — A Mental Model

### Core Philosophy

Plotly R follows a layered grammar of graphics approach, similar to ggplot2, but optimized for interactive web-based visualizations. It translates R code into JSON specifications that render via the Plotly.js library.

**Workflow basics:** Create a figure → add traces → configure layout

### Core Object Model

-   Everything is a figure: `p <- plot_ly(...)` returns a plotly figure object
-   You mutate it by adding or modifying components

```         
p <- plot_ly()
p <- p %>% add_trace(...)
p <- p %>% layout(...)
```

-   Nothing is “drawn” until the figure is printed or returned.

### Data is attached at the trace level

-   Plotly does not have a global dataset in the same sense as ggplot2.
-   Enables multiple datasets per plot
-   Enables drop-down filtering and toggles
-   Matches Plotly.js

```         
# This works
plot_ly(data = df) %>%
  add_trace(x = ~a, y = ~b)

# This also works
plot_ly() %>%
 add_trace(data = df_1, x = ~a, y = ~b) %>%
 add_trace(data = df_2, x = ~c, y = ~d)
```

### Traces (The Fundamental Unit)

-   A trace = one visual layer
-   Everything you see is a trace (e.g. one scatter layer/one line/one bar group)
-   Legends, toggles, and dropdowns all operate on trace visibility.

### Visual Grammar - `type` and `mode`

-   type defines the chart family (scatter/bar/box/histogram/pie/heatmap/scatter3d/etc...)
-   mode refines scatter behaviour (i.e. controls the visual representation)and ONLY applies to type = "scatter"
-   mode can be (markers/lines/lines+markers/text)

### Formula interface

-   Plotly uses R formulas for mappings:
-   `~` means “evaluate in the data”
-   Works like `with(data, ...)` - it tells plotly to look for that variable name within the data frame

### Visual Properties Are Lists

-   Anything visual is controlled via nested lists.

```         
marker = list(
 size = 10,
 color = "red",
 opacity = 0.7,
 line = list(width = 1, color = "black")
)
```

### Layout Is Global Configuration -

-   `layout()` modifies the whole figure - `layout()` - is used to modify Titles/Axes/Legends/Margins/Annotations/Interactivity controls -

-   Nothing in `layout()` refers to data

### Hover text and interactivity

-   is trace state dependent (out of the box)

-   can be modified (based on trace visibility)

------------------------------------------------------------------------

# Part B: Main Chart Types in Plotly

## 1. Scatter Plot

Basic scatter plot showing the relationship between car weight and miles per gallon.

```{r scatter-basic}
# Using the mtcars dataset
plot_ly(data = mtcars , 
        x = ~wt, 
        y = ~mpg, 
        type = 'scatter',
        mode = 'markers',
        marker = list(size = 10, color = 'blue')) %>%
  layout(title = "Car Weight vs MPG",
         xaxis = list(title = "Weight (1000 lbs)"),
         yaxis = list(title = "Miles Per Gallon"))
```

## 2. Line Plot

```{r line-plot}
# NOTE! - need to order the points so they connect correctly
mtcars_sorted <- mtcars[order(mtcars$wt), ]

plot_ly(data = mtcars_sorted, 
        x = ~wt, 
        y = ~mpg, 
        type = 'scatter',
        mode = 'lines', # Change the mode - from 'markers' to 'lines'
        marker = list(size = 10, color = 'blue')
       ) |>
  layout(title = "Car Weight vs MPG",
         xaxis = list(title = "Weight (1000 lbs)"),
         yaxis = list(title = "Miles Per Gallon"))
```

## 3. Bar Chart

```{r bar-chart}
# Aggregate data to get mean MPG per cyl category
mpg_by_cyl <- mtcars |>
  group_by(cyl) |>
  summarise(avg_mpg = mean(mpg))

plot_ly(data = mpg_by_cyl,
        x = ~factor(cyl),
        y = ~avg_mpg,
        type = 'bar',
        marker = list(color = 'darkgreen')) |>
  layout(title = "Average MPG by Number of Cylinders",
         xaxis = list(title = "Cylinders"),
         yaxis = list(title = "Average MPG"))
```

## 4. Box Plot

Distribution comparison across groups.

```{r box-plot}
plot_ly(data = iris,
        y = ~Sepal.Length,
        color = ~Species,
        type = 'box') %>%
  layout(title = "Sepal Length Distribution by Species",
         yaxis = list(title = "Sepal Length (cm)"))
```

## 5. Histogram

Distribution of a continuous variable.

```{r histogram}
plot_ly(x = ~iris$Petal.Length,
        type = 'histogram',
        nbinsx = 20,
        marker = list(color = 'coral',
                     line = list(color = 'black', width = 1))) %>%
  layout(title = "Distribution of Petal Length",
         xaxis = list(title = "Petal Length (cm)"),
         yaxis = list(title = "Frequency"))
```

## 6. Heatmap

2D density or correlation matrix visualization.

```{r heatmap}
# Create correlation matrix
cor_matrix <- cor(mtcars[, c("mpg", "disp", "hp", "wt", "qsec")])

plot_ly(z = ~cor_matrix,
        x = colnames(cor_matrix),
        y = rownames(cor_matrix),
        type = 'heatmap',
        colorscale = 'RdBu',
        zmid = 0) %>%
  layout(title = "Correlation Matrix of Car Attributes",
         xaxis = list(title = ""),
         yaxis = list(title = ""))
```

## 7. 3D Scatter Plot

Three-dimensional relationships.

```{r scatter-3d}
plot_ly(data = iris,
        x = ~Sepal.Length,
        y = ~Sepal.Width,
        z = ~Petal.Length,
        color = ~Species,
        type = 'scatter3d',
        mode = 'markers',
        marker = list(size = 5)) %>%
  layout(title = "3D Iris Measurements",
         scene = list(
           xaxis = list(title = "Sepal Length"),
           yaxis = list(title = "Sepal Width"),
           zaxis = list(title = "Petal Length")
         ))
```

------------------------------------------------------------------------

# A pyramid plot journey...

### Pyramid plot (% deaths by age category by sex)

-   Data input and wrangling

```{r step1-basic}
# Read in the data 
# `prop` is a column in the data that holds the % deaths for that age cat
# Males have a negative `prop` to enable this figure to work
pyramid_death_data <- read_csv(here('input', 'deaths_pyramid_data.csv'), show_col_types = FALSE)

# Ensure age category levels are ordered correctly
pyramid_death_data_recoded <- pyramid_death_data |>
  dplyr::mutate(age_label = factor(age_label, 
                                   levels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95-99", "100+")))
```

-   Note the modification I've made to get bespoke hover info showing in the figure (there is more than one way to specify hover info in plotly!)

```{r step1-basic}
# Pyramid plot
pyramid_plot <- plot_ly(
    # keep only Qld data at this stage
    data = filter(pyramid_death_data_recoded, geo_label == "Queensland")) |>
    add_bars(
      x = ~prop, 
      y = ~age_label,
      color = ~sex_label,
      orientation = 'h', # horizontal
      colors = c("#563188", "#BBA4D9"),
      # Modify hover text appearance and content
      text = ~ paste0(sex_label, "\n", 
                      "Year: ", time_period, "\n",
                      "Age group (", age_label, "): ", sprintf("%.1f", abs(prop)),"%"),
      textposition = 'none',
      hoverinfo = 'text',
      showlegend = FALSE,
      visible = TRUE
    ) |>
    layout(
      bargap = 0.1,
      barmode = 'overlay',
      yaxis = list(title = list(text = 'Age group', standoff = 10)),
      xaxis = list(title = "% of deaths by age and sex",
                   tickmode = 'array',
                   tickvals = c(-15, -10, -5, 0, 5, 10, 15),
                   ticktext = c('15', '10', '5', '0', '5', '10', '15')
                  ),
        autosize = T
    )
pyramid_plot
```

## Adding Drop Down Buttons

#### What are `updatemenus`?

`updatemenus` are **UI controls** (dropdowns, buttons, toggles) that let users **change the state of an existing figure** *without re-drawing it* .

-   They do **not**: Load new data / Re-run R code / Trigger Shiny reactivity

-   They **only modify the current figure state**.

-   The three things that matter:

    1.  **`type`** – how the control looks

    2.  **`method`** – *what kind* of update happens (restyle, relayout, update)

    3.  **`args`** – *what exactly* gets changed

```{r step2-traces}
pyramid_by_geo <- plot_ly() |>
    # add first visible trace - Queensland - with legend on
  add_bars(data = filter(pyramid_death_data_recoded,
                         geo_label == "Queensland"),
           x = ~prop,
           y = ~age_label,
           color = ~sex_label,
           orientation = 'h',
           colors = c("#563188", "#BBA4D9"),
           text = ~paste0("Age group (", age_label, "): ", abs(prop), "%"),
           textposition = 'none',
           hoverinfo = 'text',
           showlegend = TRUE,
           visible = TRUE) |>
    # add second 'hidden' trace - Australia -  with legend off
  add_bars(data = filter(pyramid_death_data_recoded,
                         geo_label == "Australia"),
           x = ~prop,
           y = ~age_label,
           color = ~sex_label,
           colors = c("#563188", "#BBA4D9"),
           orientation = 'h',
           text = ~paste0("Age group (", age_label, "): ", abs(prop), "%"),
           textposition = 'none',
           hoverinfo = 'text',
           showlegend = TRUE,
           visible = FALSE) |>
  layout(bargap = 0.1,
         barmode = 'overlay',
         yaxis = list(title = 'Age group'),
         xaxis = list(title = '% of Deaths',
                      tickmode = 'array',
                      tickvals = c(-15, -10, -5, 0, 5, 10, 15),
                      ticktext = c('15', '10', '5', '0', '5', '10', '15'))

# Add dropdown option  
pyramid_by_geo <- pyramid_by_geo |>
  layout(updatemenus = list(
           list(
             x = 0,
             y = 1.2,
             type = "dropdown",
             buttons = list(
               list(label = "Queensland", method = "update",
                    # this list refers to Qld_males, Qld_females, Aust_males, Aust_females)
                    args = list(list(visible = c(TRUE, TRUE, FALSE, FALSE)),
                                list(title = ""))),
               list(label = "Australia", method = "update",
                    args = list(list(visible = c(FALSE, FALSE, TRUE, TRUE)),
                                list(title = "")))
             )
           )
         ),
         margin = list(b = 130, r = 80),
         legend = list(
           orientation = "h",  # Horizontal layout
           x = 0.5,            # Center the legend horizontally
           y = 1.1,            # Position the legend below the plot area
           xanchor = "center", # Anchor the legend at its center
           yanchor = "top"     # Anchor the legend above the specified y position
         ) 
         ) 

pyramid_by_geo
```

## Animating a figure

-   We are going to show changes in Qld mortality rates over time

```{r step1-basic}
# Read in the mortality data 
mort_data <- read_csv(here('input', 'mort_pyramid_data.csv'), show_col_types = FALSE)
mort_data_recoded <- mort_data |> 
    dplyr::mutate(age_label = factor(age_label, 
                                   levels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95-99", "100+")))
```

```{r step3-styling}
mort_animation_plot <-
        plot_ly(data = mort_data_recoded) |>
          add_trace(
          x = ~prop,
          y = ~age_label,
          frame = ~time_period,
          color = ~sex_label,
          type = 'bar',
          orientation = 'h',
          colors = c("#563188", "#BBA4D9"),
          text = ~hovertext_col,
          textposition = 'none',
          hoverinfo = 'text',
          showlegend = FALSE,
          visible = TRUE,
          x = 'x1',
          y = 'y1'
        )
mort_animation_plot
```

## Step 4: Enhanced Hover Information

Add rich hover text with multiple data points.

```{r step4-hover}
# Prepare hover text with car name and additional info
mtcars$car_name <- rownames(mtcars)

# Create custom hover text
mtcars$hover_text <- paste0(
  "<b>", mtcars$car_name, "</b><br>",
  "HP: ", mtcars$hp, "<br>",
  "MPG: ", mtcars$mpg, "<br>",
  "Weight: ", mtcars$wt, " (1000 lbs)<br>",
  "Cylinders: ", mtcars$cyl, "<br>",
  "Transmission: ", mtcars$transmission
)

p4 <- plot_ly(data = mtcars %>% filter(transmission == "Automatic"),
              x = ~hp,
              y = ~mpg,
              name = 'Automatic',
              type = 'scatter',
              mode = 'markers',
              marker = list(size = 12, 
                           color = colors['Automatic'],
                           line = list(color = 'white', width = 1)),
              text = ~hover_text,
              hoverinfo = 'text') %>%
  add_trace(data = mtcars %>% filter(transmission == "Manual"),
            x = ~hp,
            y = ~mpg,
            name = 'Manual',
            marker = list(size = 12,
                         color = colors['Manual'],
                         line = list(color = 'white', width = 1)),
            text = ~hover_text,
            hoverinfo = 'text')

p4 %>%
  layout(
    title = list(
      text = "Step 4: Enhanced Hover Information",
      font = list(family = "Arial, sans-serif", size = 20, color = '#2C3E50')
    ),
    xaxis = list(
      title = "Horsepower",
      titlefont = list(size = 16, family = "Arial, sans-serif")
    ),
    yaxis = list(
      title = "Miles Per Gallon",
      titlefont = list(size = 16, family = "Arial, sans-serif")
    ),
    plot_bgcolor = '#F8F9FA',
    paper_bgcolor = '#FFFFFF',
    hoverlabel = list(
      bgcolor = "white",
      font = list(family = "Arial, sans-serif", size = 12)
    )
  )
```

## Step 5: Adding Dropdown Menus for Interactive Filtering

Final step: add dropdown menus to switch between different Y-axis variables.

```{r step5-dropdown}
# Prepare data with hover text for different variables
mtcars_full <- mtcars %>%
  mutate(
    hover_mpg = paste0("<b>", car_name, "</b><br>",
                       "HP: ", hp, "<br>",
                       "MPG: ", mpg, "<br>",
                       "Transmission: ", transmission),
    hover_qsec = paste0("<b>", car_name, "</b><br>",
                        "HP: ", hp, "<br>",
                        "Quarter Mile Time: ", qsec, " sec<br>",
                        "Transmission: ", transmission),
    hover_wt = paste0("<b>", car_name, "</b><br>",
                      "HP: ", hp, "<br>",
                      "Weight: ", wt, " (1000 lbs)<br>",
                      "Transmission: ", transmission)
  )

# Create base plot with all three Y variables
p5 <- plot_ly(data = mtcars_full %>% filter(transmission == "Automatic")) %>%
  # MPG traces (visible by default)
  add_trace(x = ~hp, y = ~mpg,
            name = 'Automatic',
            type = 'scatter', mode = 'markers',
            marker = list(size = 12, color = colors['Automatic'],
                         line = list(color = 'white', width = 1)),
            text = ~hover_mpg, hoverinfo = 'text',
            visible = TRUE) %>%
  add_trace(data = mtcars_full %>% filter(transmission == "Manual"),
            x = ~hp, y = ~mpg,
            name = 'Manual',
            type = 'scatter', mode = 'markers',
            marker = list(size = 12, color = colors['Manual'],
                         line = list(color = 'white', width = 1)),
            text = ~hover_mpg, hoverinfo = 'text',
            visible = TRUE) %>%
  # Quarter mile time traces (hidden initially)
  add_trace(data = mtcars_full %>% filter(transmission == "Automatic"),
            x = ~hp, y = ~qsec,
            name = 'Automatic',
            type = 'scatter', mode = 'markers',
            marker = list(size = 12, color = colors['Automatic'],
                         line = list(color = 'white', width = 1)),
            text = ~hover_qsec, hoverinfo = 'text',
            visible = FALSE) %>%
  add_trace(data = mtcars_full %>% filter(transmission == "Manual"),
            x = ~hp, y = ~qsec,
            name = 'Manual',
            type = 'scatter', mode = 'markers',
            marker = list(size = 12, color = colors['Manual'],
                         line = list(color = 'white', width = 1)),
            text = ~hover_qsec, hoverinfo = 'text',
            visible = FALSE) %>%
  # Weight traces (hidden initially)
  add_trace(data = mtcars_full %>% filter(transmission == "Automatic"),
            x = ~hp, y = ~wt,
            name = 'Automatic',
            type = 'scatter', mode = 'markers',
            marker = list(size = 12, color = colors['Automatic'],
                         line = list(color = 'white', width = 1)),
            text = ~hover_wt, hoverinfo = 'text',
            visible = FALSE) %>%
  add_trace(data = mtcars_full %>% filter(transmission == "Manual"),
            x = ~hp, y = ~wt,
            name = 'Manual',
            type = 'scatter', mode = 'markers',
            marker = list(size = 12, color = colors['Manual'],
                         line = list(color = 'white', width = 1)),
            text = ~hover_wt, hoverinfo = 'text',
            visible = FALSE)

# Add dropdown menu
p5 <- p5 %>%
  layout(
    title = list(
      text = "Step 5: Interactive Dropdown Menu",
      font = list(family = "Arial, sans-serif", size = 20, color = '#2C3E50')
    ),
    xaxis = list(
      title = "Horsepower",
      titlefont = list(size = 16, family = "Arial, sans-serif")
    ),
    yaxis = list(
      title = "Miles Per Gallon",
      titlefont = list(size = 16, family = "Arial, sans-serif")
    ),
    plot_bgcolor = '#F8F9FA',
    paper_bgcolor = '#FFFFFF',
    updatemenus = list(
      list(
        type = "dropdown",
        active = 0,
        buttons = list(
          list(method = "update",
               args = list(list(visible = c(TRUE, TRUE, FALSE, FALSE, FALSE, FALSE)),
                          list(yaxis = list(title = "Miles Per Gallon"))),
               label = "MPG"),
          list(method = "update",
               args = list(list(visible = c(FALSE, FALSE, TRUE, TRUE, FALSE, FALSE)),
                          list(yaxis = list(title = "Quarter Mile Time (sec)"))),
               label = "Quarter Mile Time"),
          list(method = "update",
               args = list(list(visible = c(FALSE, FALSE, FALSE, FALSE, TRUE, TRUE)),
                          list(yaxis = list(title = "Weight (1000 lbs)"))),
               label = "Weight")
        ),
        x = 0.12,
        xanchor = 'left',
        y = 1.15,
        yanchor = 'top'
      )
    )
  )

p5
```

------------------------------------------------------------------------

# Summary

## Part A Highlights

We covered the main chart types in plotly:

-   **Scatter plots**: For relationships between continuous variables
-   **Line plots**: For time series and trends
-   **Bar charts**: For categorical comparisons
-   **Box plots**: For distribution comparisons across groups
-   **Histograms**: For single variable distributions
-   **Heatmaps**: For correlation matrices and 2D densities
-   **3D scatter plots**: For multivariate relationships

## Part B Progression

We built up interactive features systematically:

1.  **Basic scatter plot**: Simple starting point
2.  **Multiple traces**: Comparing groups (transmission types)
3.  **Custom styling**: Colors, fonts, and visual enhancements
4.  **Rich hover text**: Detailed information on mouse-over
5.  **Dropdown menus**: Interactive variable selection

## Key Plotly Concepts

-   **`plot_ly()`**: Main function to create plots
-   **`add_trace()`**: Add additional data series
-   **`layout()`**: Customize plot appearance and interactivity
-   **`type`**: Specifies chart type (scatter, bar, box, etc.)
-   **`mode`**: For scatter plots (markers, lines, or both)
-   **`marker`**: Customize point appearance
-   **`text` & `hoverinfo`**: Control hover text display
-   **`updatemenus`**: Add interactive controls (dropdowns, buttons)

## Additional Resources

-   Plotly R documentation: https://plotly.com/r/
-   Plotly R book: https://plotly-r.com/
-   Gallery of examples: https://plotly.com/r/