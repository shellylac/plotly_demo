---
title: "Plotly Tutorial for R: Interactive Visualizations"
author: "Tutorial"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Setup

```{r load-packages}
# Install if needed: install.packages("plotly")
library(plotly)
library(dplyr)
library(readr)
library(here)
library(htmlwidgets)
```

------------------------------------------------------------------------

# Plotly (R) Grammar — A Mental Model

### Core Philosophy

Plotly R follows a layered grammar of graphics approach, similar to ggplot2, but optimized for interactive web-based visualizations. It translates R code into JSON specifications that render via the Plotly.js library.

**Workflow basics:** Create a figure → add traces → configure layout

### Core Object Model

-   Everything is a figure: `p <- plot_ly(...)` returns a plotly figure object
-   You mutate it by adding or modifying components

```         
p <- plot_ly()
p <- p |> add_trace(...)
p <- p |> layout(...)
```

-   Nothing is “drawn” until the figure is printed or returned.

### Data is attached at the trace level

-   Plotly does not have a global dataset in the same sense as ggplot2.
-   Enables multiple datasets per plot
-   Enables drop-down filtering and toggles
-   Matches Plotly.js

```         
# This works
plot_ly(data = df) |>
  add_trace(x = ~a, y = ~b)

# This also works
plot_ly() |>
 add_trace(data = df_1, x = ~a, y = ~b) |>
 add_trace(data = df_2, x = ~c, y = ~d)
```

### Traces (The Fundamental Unit)

-   A trace = one visual layer
-   Everything you see is a trace (e.g. one scatter layer/one line/one bar group)
-   Legends, toggles, and dropdowns all operate on trace visibility.

### Visual Grammar - `type` and `mode`

-   type defines the chart family (scatter/bar/box/histogram/pie/heatmap/scatter3d/etc...)
-   mode refines scatter behaviour (i.e. controls the visual representation)and ONLY applies to type = "scatter"
-   mode can be (markers/lines/lines+markers/text)

### Formula interface

-   Plotly uses R formulas for mappings:
-   `~` means “evaluate in the data”
-   Works like `with(data, ...)` - it tells plotly to look for that variable name within the data frame

### Visual Properties Are Lists

-   Anything visual is controlled via nested lists.

```         
marker = list(
 size = 10,
 color = "red",
 opacity = 0.7,
 line = list(width = 1, color = "black")
)
```

### Layout Is Global Configuration -

-   `layout()` modifies the whole figure - `layout()` - is used to modify Titles/Axes/Legends/Margins/Annotations/Interactivity controls -

-   Nothing in `layout()` refers to data

### Hover text and interactivity

-   is trace state dependent (out of the box)

-   can be modified (based on trace visibility)

------------------------------------------------------------------------

# Main Chart Types in Plotly

## 1. Scatter Plot

Basic scatter plot showing the relationship between car weight and miles per gallon.

```{r scatter-basic}
# Using the mtcars dataset
p_scatter <- plot_ly(
  data = mtcars,
  x = ~wt,
  y = ~mpg,
  type = 'scatter',
  mode = 'markers',
  marker = list(size = 10, color = 'blue')
) |>
  layout(
    title = "Car Weight vs MPG",
    xaxis = list(title = "Weight (1000 lbs)"),
    yaxis = list(title = "Miles Per Gallon")
  )

p_scatter
```

## 2. Line Plot

```{r line-plot}
# NOTE! - need to order the points so they connect correctly
mtcars_sorted <- mtcars[order(mtcars$wt), ]

p_line <- plot_ly(
  data = mtcars_sorted,
  x = ~wt,
  y = ~mpg,
  type = 'scatter',
  mode = 'lines', # Change the mode - from 'markers' to 'lines'
  line = list(color = "red")
) |>
  layout(
    title = "Car Weight vs MPG",
    xaxis = list(title = "Weight (1000 lbs)"),
    yaxis = list(title = "Miles Per Gallon")
  )

p_line
```

## 3. Bar Chart

```{r bar-chart}
# Aggregate data to get mean MPG per cyl category
mpg_by_cyl <- mtcars |>
  group_by(cyl) |>
  summarise(avg_mpg = mean(mpg))

p_bar <- plot_ly(
  data = mpg_by_cyl,
  x = ~ factor(cyl),
  y = ~avg_mpg,
  type = 'bar',
  color = ~ factor(cyl)
  # marker = list(color = 'darkgreen') # Single specified colour
) |>
  layout(
    title = "Average MPG by Number of Cylinders",
    xaxis = list(title = "Cylinders"),
    yaxis = list(title = "Average MPG")
  )

p_bar
```

## 4. Box Plot

Distribution comparison across groups.

```{r box-plot}
p_box <- plot_ly(
  data = iris,
  y = ~Sepal.Length,
  color = ~Species,
  type = 'box'
) |>
  layout(
    title = "Sepal Length Distribution by Species",
    yaxis = list(title = "Sepal Length (cm)")
  )
p_box
```

## 5. Histogram

Distribution of a continuous variable.

```{r histogram}
p_hist <- plot_ly(
  x = ~ iris$Petal.Length,
  type = 'histogram',
  nbinsx = 20,
  marker = list(color = 'coral', line = list(color = 'black', width = 1))
) |>
  layout(
    title = "Distribution of Petal Length",
    xaxis = list(title = "Petal Length (cm)"),
    yaxis = list(title = "Frequency")
  )
p_hist
```

## 6. Heatmap

2D density or correlation matrix visualization.

```{r heatmap}
# Create correlation matrix
cor_matrix <- cor(mtcars[, c("mpg", "disp", "hp", "wt", "qsec")])

p_cor <- plot_ly(
  z = ~cor_matrix,
  x = colnames(cor_matrix),
  y = rownames(cor_matrix),
  type = 'heatmap',
  colorscale = 'RdBu',
  zmid = 0
) |>
  layout(
    title = "Correlation Matrix of Car Attributes",
    xaxis = list(title = ""),
    yaxis = list(title = "")
  )
p_cor

```

## 7. 3D Scatter Plot

Three-dimensional relationships.

```{r scatter-3d}
p_3d <- plot_ly(
  data = iris,
  x = ~Sepal.Length,
  y = ~Sepal.Width,
  z = ~Petal.Length,
  color = ~Species,
  type = 'scatter3d',
  mode = 'markers',
  marker = list(size = 5)
) |>
  layout(
    title = "3D Iris Measurements",
    scene = list(
      xaxis = list(title = "Sepal Length"),
      yaxis = list(title = "Sepal Width"),
      zaxis = list(title = "Petal Length")
    )
  )
p_3d
```

------------------------------------------------------------------------

# Arranging multiple figures in a single plot - `subplot`

```{r subplots}
p_subplot <- plotly::subplot(
  p_scatter,
  p_line,
  # For side-by-side horizontal
  nrows = 1,
  # For vertical layout you use
  # nrows = 2,
  # heights = c(0.7, 0.3),  # First row: 70%, Second row: 30%
  shareX = FALSE,
  shareY = FALSE,
  titleX = TRUE,
  titleY = TRUE
)
p_subplot
```

## Saving a plot as a HTML object

```{r saving}
# Saves a stand alone HTML file 
htmlwidgets::saveWidget(
  widget = p_subplot,
  file = here('output', 'my_plotly_figure.html')
)
```

## Modifying the button options

```{r modify_config}
p_scatter <- p_scatter |>
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = c(
      "sendDataToCloud",
      "toggleSpikelines",
      "zoom2d",
      "pan2d",
      "select2d",
      "lasso2d"
    )
  )
p_scatter
```

# A pyramid plot journey...

### Pyramid plot (% deaths by age category by sex)

-   Data input and wrangling

```{r pyramid_data}
# Read in the data 
# `prop` is a column in the data that holds the % deaths for that age cat
# Males have a negative `prop` to enable this figure to work
pyramid_death_data <- read_csv(here('input', 'deaths_pyramid_data.csv'), show_col_types = FALSE)

# Ensure age category levels are ordered correctly
pyramid_death_data_recoded <- pyramid_death_data |>
  dplyr::mutate(age_label = factor(age_label, 
                                   levels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95-99", "100+")))
```

-   Note - See how you can get more bespoke hover info showing in the figure (there is more than one way to specify hover info in plotly!)

```{r pyramid_plot}
# Pyramid plot
pyramid_plot <- plot_ly(
    # keep only Qld data at this stage
    data = filter(pyramid_death_data_recoded, geo_label == "Queensland")) |>
    add_bars(
      x = ~prop, 
      y = ~age_label,
      color = ~sex_label,
      orientation = 'h', # horizontal
      colors = c("#563188", "#BBA4D9"),
      # Modify hover text appearance and content
      text = ~ paste0(sex_label, "\n", 
                      "Year: ", time_period, "\n",
                      "Age group (", age_label, "): ", sprintf("%.1f", abs(prop)),"%"),
      textposition = 'none',
      hoverinfo = 'text',
      showlegend = FALSE,
      visible = TRUE
    ) |>
    layout(
      bargap = 0.1,
      barmode = 'overlay',
      yaxis = list(title = list(text = 'Age group', standoff = 10)),
      xaxis = list(title = "% of deaths by age and sex",
                   tickmode = 'array',
                   tickvals = c(-15, -10, -5, 0, 5, 10, 15),
                   ticktext = c('15', '10', '5', '0', '5', '10', '15')
                  ),
        autosize = T
    )
pyramid_plot
```

## Adding Drop Down Buttons

#### What are `updatemenus`?

`updatemenus` are **UI controls** (dropdowns, buttons, toggles) that let users **change the state of an existing figure** *without re-drawing it* .

-   They do **not**: Load new data / Re-run R code / Trigger Shiny reactivity

-   They **only modify the current figure state**.

-   The three things that matter:

    1.  **`type`** – how the control looks

    2.  **`method`** – *what kind* of update happens (restyle, relayout, update)

    3.  **`args`** – *what exactly* gets changed

```{r pyramid_dropdown}
pyramid_by_geo <- plot_ly() |>
    # add first visible trace - Queensland - with legend on
  add_bars(data = filter(pyramid_death_data_recoded,
                         geo_label == "Queensland"),
           x = ~prop,
           y = ~age_label,
           color = ~sex_label,
           orientation = 'h',
           colors = c("#563188", "#BBA4D9"),
           text = ~paste0("Age group (", age_label, "): ", abs(prop), "%"),
           textposition = 'none',
           hoverinfo = 'text',
           showlegend = TRUE,
           visible = TRUE) |>
    # add second 'hidden' trace - Australia -  with legend off
  add_bars(data = filter(pyramid_death_data_recoded,
                         geo_label == "Australia"),
           x = ~prop,
           y = ~age_label,
           color = ~sex_label,
           colors = c("#563188", "#BBA4D9"),
           orientation = 'h',
           text = ~paste0("Age group (", age_label, "): ", abs(prop), "%"),
           textposition = 'none',
           hoverinfo = 'text',
           showlegend = TRUE,
           visible = FALSE) |>
  layout(bargap = 0.1,
         barmode = 'overlay',
         yaxis = list(title = 'Age group'),
         xaxis = list(title = '% of Deaths',
                      tickmode = 'array',
                      tickvals = c(-15, -10, -5, 0, 5, 10, 15),
                      ticktext = c('15', '10', '5', '0', '5', '10', '15'))
  )

# Add dropdown option  
pyramid_by_geo <- pyramid_by_geo |>
  layout(updatemenus = list(
           list(
             x = 0,
             y = 1.2,
             type = "dropdown",
             buttons = list(
               list(label = "Queensland", method = "update",
                    # this list refers to Qld_males, Qld_females, Aust_males, Aust_females)
                    args = list(list(visible = c(TRUE, TRUE, FALSE, FALSE)),
                                list(title = ""))),
               list(label = "Australia", method = "update",
                    args = list(list(visible = c(FALSE, FALSE, TRUE, TRUE)),
                                list(title = "")))
             )
           )
         ),
         margin = list(b = 130, r = 80),
         legend = list(
           orientation = "h",  # Horizontal layout
           x = 0.5,            # Center the legend horizontally
           y = 1.1,            # Position the legend below the plot area
           xanchor = "center", # Anchor the legend at its center
           yanchor = "top"     # Anchor the legend above the specified y position
         ) 
         ) 

pyramid_by_geo
```

## Extra example: Show All / Hide All Buttons

```{r show_all_hide_all}
p <- plot_ly(type = "scatter", mode = "markers") |>
  add_trace(
    data = iris,
    x = ~Sepal.Length,
    y = ~Sepal.Width ,
    color = ~Species
  ) |>
  layout(
    updatemenus = list(
      list(
        type = "buttons",
        buttons = list(
          list(
            label = "Show all",
            method = "restyle",
            args = list("visible", TRUE)
          ),
          list(
            label = "Hide all",
            method = "restyle",
            args = list("visible", FALSE)
          )
        )
      )
    )
  )
  p
```

## Animating a figure

-   We are going to show changes in Qld mortality rates over time (like those in the [CHO report](https://www.choreport.health.qld.gov.au/from-the-cho/ageing-and-future-healthcare-demand))

```{r mort-data-read}
# Read in the mortality data 
mort_data <- read_csv(here('input', 'mort_pyramid_data.csv'), show_col_types = FALSE)
mort_sexasr_data <- read_csv(here('input', 'mort_sexasr_data.csv'), show_col_types = FALSE)

# Ensure age category levels are ordered correctly
mort_data_recoded <- mort_data |> 
    dplyr::mutate(age_label = factor(age_label, 
                                   levels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95+")))

# Ensure sex category levels are ordered
mort_sexasr_data_recoded <- mort_sexasr_data |>
     dplyr::mutate(sex_label = factor(sex_label, levels = c("Males", "Femalse")))
```

#### The `frame` parameter

-   When you write `frame = ~year` this is what happens
    -   Splits the data by unique year
    -   Creates a frame for each value
    -   Links those frames together
    -   Adds play/pause controls automatically

```{r mort_animation}
mort_animation_plot <-
        plot_ly(data = mort_data_recoded) |>
          add_trace(
          x = ~prop,
          y = ~age_label,
          frame = ~time_period,
          color = ~sex_label,
          type = 'bar',
          orientation = 'h',
          colors = c("#563188", "#BBA4D9"),
          text = ~hovertext_col,
          textposition = 'none',
          hoverinfo = 'text',
          showlegend = FALSE,
          visible = TRUE,
          x = 'x1',
          y = 'y1'
        )

mort_animation_plot <- mort_animation_plot |>
  layout(
      bargap = 0.1,
      barmode = 'overlay',
      yaxis = list(title = list(text = 'Age group',
                                standoff = 10),
                   range = c(-0.5,
                             length(levels(mort_data_recoded$age_label)) - 0.5)
                   ),
      xaxis = list(
        range = c(min(mort_data_recoded$prop) - 1,
                  max(mort_data_recoded$prop) + 1),
        title = "% of total population"
        , tickmode = 'array'
        , tickvals = c(-15, -10, -5, 0, 5, 10, 15)
        , ticktext = c('15', '10', '5', '0', '5', '10', '15')
        , autosize = T
        , showgrid = F
      )
  ) |>
 plotly::animation_opts(frame = 180, easing = "linear", redraw = FALSE) |>
 plotly::animation_slider(currentvalue = list(prefix = "YEAR: ", font = list(color = "black")), visible = TRUE) |>
 plotly::animation_button(font = list(family = "Arial Black", size = 16),
                                   bordercolor = "#563188", 
                                   borderwidth = 1.5
                                   )
mort_animation_plot
```

-   Also Note - in the above examples we use a data column `hovertext_col` for hoverinfo.

    -   Entries in this column are formatted text: `"Females\nYear: 1971\nAge group: 0-4 years\nProportion of population: 9.7%\nCount:  88,974"`

------------------------------------------------------------------------

## Key Plotly Concepts

-   **`plot_ly()`**: Main function to create plots
-   **`add_trace()`**: Add additional data series (Also specific `add_*` functions)
-   **`layout()`**: Customize plot appearance and interactivity
-   **`type`**: Specifies chart type (scatter, bar, box, etc.)
-   **`mode`**: For scatter plots (markers, lines, or both)
-   **`marker`**: Customize point appearance
-   **`text` & `hoverinfo`**: Control hover text display
-   **`updatemenus`**: Add interactive controls (dropdowns, buttons)
-   **`subplot`**: arrange multiple plotly objects

## Additional Resources

-   Plotly R documentation: https://plotly.com/r/
-   Plotly R book: https://plotly-r.com/
-   Gallery of examples: https://plotly.com/r/